---
title: "SureTypeSCR -- converting idat to gtc"
author: "Ivan Vogel"
date: "`r format(Sys.time(), '%B %d, %Y')`"
output:   
  BiocStyle::html_document:
  highlight: pygments
  number_sections: yes
  theme: united
  toc: yes
vignette: >
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteIndexEntry{SureTypeSCR idat to gtc}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
dir.create('idat_to_gtc_test')
knitr::opts_knit$set(root.dir='idat_to_gtc_test')
```

# Introduction

SureTypeSCR is equipped with simple wrapper that facilitates conversion from IDAT to GTC. Illumina's IAAP-cli is required for running the conversion and the user is guided to download this software. We demonstrate the conversion on publicly available sperm data from the GEO database. Following entities are required (on the top of SureTypeSCR dependencies) to run this demo:

-   IAAP CLI (<https://emea.support.illumina.com/downloads/iaap-genotyping-cli.html>) - the user will be requested to choose path to this software at first run of function **idat_to_gtc(.)**

-   R package for retrieving GEO data and metadata - [GEOquery](https://www.bioconductor.org/packages/release/bioc/html/GEOquery.html)

## Initialization and data retrieval

We initialize the required packages, load metadata related to **GSE19247** and select only **MDA** amplified sperm data

```{r init, echo=TRUE, warning=FALSE, results='hide',error=FALSE,message=FALSE}
library(GEOquery)
library(SureTypeSCR)

gse <- getGEO("GSE19247",GSEMatrix = TRUE)

samplelist_sperm=as.data.frame(gse$`GSE19247-GPL6985_series_matrix.txt.gz`) %>% 
  filter((str_detect(cell.type.ch1,'sperm')) & str_detect(cell.amplication.ch1,'MDA')) %>%
  rownames()  
```

```{r samplelist}
samplelist_sperm
```

We then use function **getGEO_and_folder(.)** to download the samples defined in **samplelist_sperm.** The idat files originating from the same array are downloaded into a common folder and the name of the folder corresponds to the array ID. Having idat files grouped by the array ID is the required by the conversion software (IAAP-cli).

```{r download,cache=TRUE}
metadf_sperm=map_if(samplelist_sperm,function(x) !is.null(x),function(x) SureTypeSCR::getGEO_and_folder_in(x,download=TRUE))
metadf_sperm[[1]]
```

Every element of **metadf_sperm** stores record about a single sperm sample - we collapse all records into single data frame by running the following code.

```{r collapse, cache=TRUE}
metadf_sperm_merged = Reduce(function(...) merge(..., all=T), metadf_sperm)
head(metadf_sperm_merged)
```

Now we query the function **idat_to_gtc** (which is essentially the wrapper for IAAAP cli)over all **arrayid**'s. At this stage manifest and cluster file are required (deployed with the package for this type of array - Human CytoSNP array).

```{r idat_to_gtc,echo=FALSE}.}
manifest=system.file("files/HumanCytoSNP-12v2_H.bpm",package="SureTypeSCR")
cluster=system.file("files/HumanCytoSNP-12v2_H.egt",package="SureTypeSCR")

for (ar in unique(metadf_sperm_merged$arrayid))
{
  idat_to_gtc(ar,'GTC',manifest,cluster)
}


```

In the final stage we create sample sheet that links the sample names with their array ID and position on the array:

```{r samplesheet,warning=FALSE}
SureTypeSCR::write_samplesheet('samplesheet.csv',metadf_sperm_merged,'GTC',manifest)
head(read.csv('samplesheet.csv'))
```

Now we can test whether we can load the GTC files listed in the sample sheet using function **scbasic(.)**

```{r load_test}
df=SureTypeSCR::scbasic(manifest,cluster,'samplesheet.csv')
head(df)
```
